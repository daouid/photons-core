

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>photons_transport &mdash; Photons 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Photons 0.1 documentation" href="../index.html"/>
        <link rel="up" title="Available Photons Modules" href="../available_modules.html"/>
        <link rel="prev" title="photons_transform" href="photons_transform.html"/>
   
	<link rel="stylesheet" href="../_static/css/styles.css" type="text/css"/>


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Photons
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../lifx_script.html">LIFX script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scripts.html">Making a Photons Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../library.html">Using Photons as a library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../venvstarter.html">Using Venvstarter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../script_mechanism.html">The Script Mechanism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../finding_serials.html">Finding Serials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packets.html">Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../known_issues.html">Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">ChangeLog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../photons_app/index.html">photons_app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../binary_protocol.html">LIFX Binary protocol</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../available_modules.html">Available Photons Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="photons_attributes.html">photons_attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_colour.html">photons_colour</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_core.html">photons_core</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_device_finder.html">photons_device_finder</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_device_messages.html">photons_device_messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_docs.html">photons_docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_multizone.html">photons_multizone</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_products_registry.html">photons_products_registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_protocol.html">photons_protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_script.html">photons_script</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_socket.html">photons_socket</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_themes.html">photons_themes</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_tile_messages.html">photons_tile_messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="photons_transform.html">photons_transform</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">photons_transport</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-photons_transport.target.target">The target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-photons_transport.target.bridge">The bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-photons_transport.target.item">The item</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-photons_transport.target.waiter">The waiter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-photons_transport.target.writer">The writer</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Photons</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../available_modules.html">Available Photons Modules</a> &raquo;</li>
        
      <li>photons_transport</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/modules/photons_transport.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="photons-transport">
<span id="id1"></span><h1>photons_transport<a class="headerlink" href="#photons-transport" title="Permalink to this headline">¶</a></h1>
<span class="target" id="module-photons_transport"></span><p>Core functionality for making photons transports. These are objects responsible
for getting messages to a device.</p>
<dl class="docutils">
<dt>TASK:: find_devices</dt>
<dd>Print the devices that can be found</dd>
</dl>
<span class="target" id="module-photons_transport.target"></span><p>A transport is essentially functionality for getting messages as objects and sending
them to devices as binary (or as http) (or as nats messages, etc)</p>
<p>We have three concepts here:</p>
<dl class="docutils">
<dt>TransportItem</dt>
<dd>Responsible for formatting the raw messages and writing them to the device</dd>
<dt>TransportBridge</dt>
<dd>Also known as args_for_run or afr, this holds the logic for actually doing
the writing/reading</dd>
<dt>TransportTarget</dt>
<dd><p class="first">Responsible for holding onto a references to TransportItem and TransportBridge</p>
<p class="last">May contain classmethods for common tasks.</p>
</dd>
</dl>
<div class="section" id="module-photons_transport.target.target">
<span id="the-target"></span><h2>The target<a class="headerlink" href="#module-photons_transport.target.target" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="photons_transport.target.target.TransportTarget">
<em class="property">class </em><code class="descclassname">photons_transport.target.target.</code><code class="descname">TransportTarget</code><span class="sig-paren">(</span><em>default_broadcast</em>, <em>description</em>, <em>final_fut_finder</em>, <em>protocols</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget" title="Permalink to this definition">¶</a></dt>
<dd><p>This is responsible for bringing together the TransportBridge and the TransportItems</p>
<p>It implements the ability to create and destroy args_for_run (the bridge), as well as
creating a <cite>script</cite> that may be run with <cite>script.run_with</cite>.</p>
<p>We also have higher order functions for finding and forgetting devices.</p>
<p>When creating your own target do something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SocketTarget</span><span class="p">(</span><span class="n">TransportTarget</span><span class="p">):</span>
    <span class="n">item_kls</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">SocketItem</span>
    <span class="n">bridge_kls</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">SocketBridge</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">dictobj</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">string_spec</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Understands how to talk to a device over a TCP socket&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">protocols</span></code> and <code class="docutils literal"><span class="pre">final_fut_finder</span></code> are retrieved automatically from
<code class="docutils literal"><span class="pre">Meta</span></code> if we create the transport by doing
<code class="docutils literal"><span class="pre">TransportTarget.normalise(meta,</span> <span class="pre">**kwargs)</span></code></p>
<p>Generally you’ll be passed in a transport via the <code class="docutils literal"><span class="pre">tasks</span></code> mechanism and
you won’t have to instantiate it yourself.</p>
<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.args_for_run">
<em class="property">await </em><code class="descname">args_for_run</code><span class="sig-paren">(</span><em>found=None</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.args_for_run" title="Permalink to this definition">¶</a></dt>
<dd><p>Create an instance of args_for_run. This is designed to be shared amongst many <cite>script</cite></p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.close_args_for_run">
<em class="property">await </em><code class="descname">close_args_for_run</code><span class="sig-paren">(</span><em>args_for_run</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.close_args_for_run" title="Permalink to this definition">¶</a></dt>
<dd><p>Close an args_for_run</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.device_forgetter">
<code class="descname">device_forgetter</code><span class="sig-paren">(</span><em>args_for_run</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.device_forgetter" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a function that may be used to forget a device on this args_for_run</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.find">
<code class="descname">find</code><span class="sig-paren">(</span><em>args_for_run</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.find" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a function that may be used to find a device on this args_for_run</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.get_list">
<em class="property">await </em><code class="descname">get_list</code><span class="sig-paren">(</span><em>args_for_run</em>, <em>broadcast=&lt;class 'input_algorithms.spec_base.NotSpecified'&gt;</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.get_list" title="Permalink to this definition">¶</a></dt>
<dd><p>Return us the targets that we can find from this bridge</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.script">
<code class="descname">script</code><span class="sig-paren">(</span><em>raw</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.script" title="Permalink to this definition">¶</a></dt>
<dd><p>Return us a ScriptRunnerIterator for the given <cite>raw</cite> against this <cite>target</cite></p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.target.TransportTarget.simplify">
<em class="property">for ... in </em><code class="descname">simplify</code><span class="sig-paren">(</span><em>script_part</em>, <em>chain=None</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.target.TransportTarget.simplify" title="Permalink to this definition">¶</a></dt>
<dd><p>Used by <code class="docutils literal"><span class="pre">self.script</span></code> to convert <code class="docutils literal"><span class="pre">raw</span></code> into TransportItems</p>
<p>For each leaf child that is found, we gather messages into groups of
messages with a <code class="docutils literal"><span class="pre">pack</span></code> method and yield <code class="docutils literal"><span class="pre">self.item_kls()(group)</span></code> with
messages that don’t have a <code class="docutils literal"><span class="pre">pack</span></code> method yield as is.</p>
<p>For example, let’s say we have <code class="docutils literal"><span class="pre">[p1,</span> <span class="pre">p2,</span> <span class="pre">m1,</span> <span class="pre">p3]</span></code> where <code class="docutils literal"><span class="pre">m1</span></code> does
not have a <code class="docutils literal"><span class="pre">pack</span></code> method and the others do, we’ll yield:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">self.item_kls()([p1,</span> <span class="pre">p2])</span></code></li>
<li><code class="docutils literal"><span class="pre">m1</span></code></li>
<li><code class="docutils literal"><span class="pre">self.item_kls()([p3])</span></code></li>
</ul>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-photons_transport.target.bridge">
<span id="the-bridge"></span><h2>The bridge<a class="headerlink" href="#module-photons_transport.target.bridge" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="photons_transport.target.bridge.TransportBridge">
<em class="property">class </em><code class="descclassname">photons_transport.target.bridge.</code><code class="descname">TransportBridge</code><span class="sig-paren">(</span><em>stop_fut</em>, <em>transport_target</em>, <em>protocol_register</em>, <em>found=None</em>, <em>default_broadcast='255.255.255.255'</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge" title="Permalink to this definition">¶</a></dt>
<dd><p>The core of the transport!</p>
<p>This is responsible for writing to, and reading from some connection(s).</p>
<p>Usage is something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBridge</span><span class="p">(</span><span class="n">Transportbridge</span><span class="p">):</span>
    <span class="n">Messages</span> <span class="o">=</span> <span class="n">KnownMessages</span>
    <span class="n">default_desired_services</span> <span class="o">=</span> <span class="p">[</span><span class="n">Services</span><span class="o">.</span><span class="n">UDP</span><span class="p">]</span>

<span class="n">bridge</span> <span class="o">=</span> <span class="n">MyBridge</span><span class="p">(</span><span class="o">....</span><span class="p">)</span>
<span class="n">await</span> <span class="n">bridge</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># Interact with bridge</span>

<span class="n">bridge</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
<p>Writing to the bridge and waiting for a reply looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">packet</span> <span class="o">=</span> <span class="n">Messages</span><span class="o">.</span><span class="n">GetService</span><span class="p">()</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">await</span> <span class="n">bridge</span><span class="o">.</span><span class="n">make_writer</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
<span class="n">reply</span> <span class="o">=</span> <span class="n">await</span> <span class="n">bridge</span><span class="o">.</span><span class="n">make_waiter</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.start">
<em class="property">await </em><code class="descname">start</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.start" title="Permalink to this definition">¶</a></dt>
<dd><p>Hook for logic that happens when the bridge starts</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.finish">
<code class="descname">finish</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.finish" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="docutils">
<dt>Useful</dt>
<dd><dl class="first method">
<dt id="photons_transport.target.bridge.TransportBridge.source">
<code class="descname">source</code><span class="sig-paren">(</span><em>is_broadcast</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.source" title="Permalink to this definition">¶</a></dt>
<dd><p>Return us a source to use for our packet</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.seq">
<code class="descname">seq</code><span class="sig-paren">(</span><em>target</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.seq" title="Permalink to this definition">¶</a></dt>
<dd><p>Create the next sequence for this target</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.forget">
<em class="property">await </em><code class="descname">forget</code><span class="sig-paren">(</span><em>serial</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.forget" title="Permalink to this definition">¶</a></dt>
<dd><p>Forget the location of a device</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.target_is_at">
<code class="descname">target_is_at</code><span class="sig-paren">(</span><em>serial</em>, <em>address</em>, <em>port</em>, <em>service</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.target_is_at" title="Permalink to this definition">¶</a></dt>
<dd><p>Hard code the location of a device</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.find">
<em class="property">await </em><code class="descname">find</code><span class="sig-paren">(</span><em>target</em>, <em>broadcast=&lt;class 'input_algorithms.spec_base.NotSpecified'&gt;</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.find" title="Permalink to this definition">¶</a></dt>
<dd><p>Find all the devices we can</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.make_writer">
<em class="property">await </em><code class="descname">make_writer</code><span class="sig-paren">(</span><em>packet</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.make_writer" title="Permalink to this definition">¶</a></dt>
<dd><p>Make an object for writing to this bridge</p>
</dd></dl>

<dl class="last method">
<dt id="photons_transport.target.bridge.TransportBridge.make_waiter">
<code class="descname">make_waiter</code><span class="sig-paren">(</span><em>writer</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.make_waiter" title="Permalink to this definition">¶</a></dt>
<dd><p>Make a future for waiting on a writer to get a reply</p>
</dd></dl>

</dd>
<dt>Hooks</dt>
<dd><dl class="first method">
<dt id="photons_transport.target.bridge.TransportBridge.write_to_sock">
<code class="descname">write_to_sock</code><span class="sig-paren">(</span><em>sock</em>, <em>addr</em>, <em>packet</em>, <em>bts</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.write_to_sock" title="Permalink to this definition">¶</a></dt>
<dd><p>Hook for writing to a socket</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.create_receiver">
<em class="property">await </em><code class="descname">create_receiver</code><span class="sig-paren">(</span><em>conn</em>, <em>packet</em>, <em>addr</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.create_receiver" title="Permalink to this definition">¶</a></dt>
<dd><p>Hook for creating a receiver</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.bridge.TransportBridge.spawn_conn">
<em class="property">await </em><code class="descname">spawn_conn</code><span class="sig-paren">(</span><em>address</em>, <em>backoff=0.05</em>, <em>target=None</em>, <em>timeout=10</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.spawn_conn" title="Permalink to this definition">¶</a></dt>
<dd><p>Hook for spawning a connection for a particular address</p>
</dd></dl>

<dl class="last method">
<dt id="photons_transport.target.bridge.TransportBridge.find_devices">
<em class="property">await </em><code class="descname">find_devices</code><span class="sig-paren">(</span><em>broadcast</em>, <em>ignore_lost=False</em>, <em>raise_on_none=False</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.bridge.TransportBridge.find_devices" title="Permalink to this definition">¶</a></dt>
<dd><p>Hook for finding devices</p>
</dd></dl>

</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-photons_transport.target.item">
<span id="the-item"></span><h2>The item<a class="headerlink" href="#module-photons_transport.target.item" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="photons_transport.target.item.Done">
<em class="property">class </em><code class="descclassname">photons_transport.target.item.</code><code class="descname">Done</code><a class="headerlink" href="#photons_transport.target.item.Done" title="Permalink to this definition">¶</a></dt>
<dd><p>Used to specify when we should close a queue</p>
</dd></dl>

<dl class="class">
<dt id="photons_transport.target.item.TransportItem">
<em class="property">class </em><code class="descclassname">photons_transport.target.item.</code><code class="descname">TransportItem</code><span class="sig-paren">(</span><em>parts</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.item.TransportItem" title="Permalink to this definition">¶</a></dt>
<dd><p>Responsible for Writing our parts to our devices.</p>
<ul class="simple">
<li>Determines final messages from the parts</li>
<li>Finds what devices it can</li>
<li>Writes to those messages</li>
<li>Raises error or returns results</li>
</ul>
<p>Usage is through TransportTarget:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">some</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">TransportTarget</span><span class="o">&gt;</span>
<span class="n">script</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="o">&lt;</span><span class="n">some</span> <span class="n">message</span><span class="o">&gt;</span><span class="p">)</span>

<span class="c1"># Transport item comes into play here</span>
<span class="n">script</span><span class="o">.</span><span class="n">run_with</span><span class="p">([</span><span class="n">selector</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">....</span><span class="p">])</span>

<span class="c1"># or if you already have an afr</span>
<span class="n">script</span><span class="o">.</span><span class="n">run_with</span><span class="p">([</span><span class="n">selector</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="o">....</span><span class="p">],</span> <span class="n">afr</span><span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="photons_transport.target.item.TransportItem.make_packets">
<code class="descname">make_packets</code><span class="sig-paren">(</span><em>afr</em>, <em>serials</em>, <em>broadcast</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.item.TransportItem.make_packets" title="Permalink to this definition">¶</a></dt>
<dd><p>Create and fill in the packets from our parts</p>
<p>This means that for each reference and each part we create a clone of
the part with the target set to the reference, complete with a source and
sequence</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.item.TransportItem.run_with">
<em class="property">async for ... in </em><code class="descname">run_with</code><span class="sig-paren">(</span><em>serials</em>, <em>args_for_run</em>, <em>broadcast=False</em>, <em>multiple_replies=False</em>, <em>first_wait=0.05</em>, <em>accept_found=False</em>, <em>found=None</em>, <em>error_catcher=None</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.item.TransportItem.run_with" title="Permalink to this definition">¶</a></dt>
<dd><p>Entry point to this item, the idea is you create a <cite>script</cite> with the
target and call <cite>run_with</cite> on the script, which ends up calling this</p>
<p>We acknowledge the following keyword arguments.</p>
<dl class="docutils">
<dt>broadcast</dt>
<dd>Whether we are broadcasting these messages or just unicasting directly
to each device</dd>
<dt>multiple_replies</dt>
<dd><p class="first">Whether we expect multiple replies from a single messsage.</p>
<p class="last">This must be True if we are broadcasting</p>
</dd>
<dt>first_wait</dt>
<dd>Time, in seconds, we wait for our first reply before retrying</dd>
<dt>find_timeout</dt>
<dd>timeout for finding devices</dd>
<dt>connect_timeout</dt>
<dd>timeout for connecting to devices</dd>
<dt>timeout</dt>
<dd>timeout for writing messages</dd>
<dt>found</dt>
<dd><p class="first">A dictionary of
<code class="docutils literal"><span class="pre">{targetHex:</span> <span class="pre">(set([(ServiceType,</span> <span class="pre">addr),</span> <span class="pre">(ServiceType,</span> <span class="pre">addr),</span> <span class="pre">...]),</span> <span class="pre">broadcastAddr)}</span></code></p>
<p class="last">If this is not provided, one is made for us</p>
</dd>
<dt>accept_found</dt>
<dd>Accept the found that was given and don’t try to change it</dd>
<dt>error_catcher</dt>
<dd><p class="first">A list that errors will be appended to instead of being raised.</p>
<p>Or a callable that takes in the error as an argument.</p>
<p>If this isn’t specified then errors are raised after all the received
messages have been yielded.</p>
<p class="last">Note that if there is only one serial that we sent messages to, then
any error is raised as is. Otherwise we raise a
<code class="docutils literal"><span class="pre">photons_app.errors.RunErrors</span></code>, with all the errors in a list on
the <code class="docutils literal"><span class="pre">errors</span></code> property of the RunErrors exception.</p>
</dd>
</dl>
<ul class="simple">
<li>First we make the packets.</li>
<li>Then we find the devices (unless found is supplied)</li>
<li>Then we send the packets to the devices</li>
<li>Then we gather results and errors</li>
</ul>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.item.TransportItem.search">
<em class="property">await </em><code class="descname">search</code><span class="sig-paren">(</span><em>afr</em>, <em>found</em>, <em>packets</em>, <em>broadcast_address</em>, <em>find_timeout</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.item.TransportItem.search" title="Permalink to this definition">¶</a></dt>
<dd><p>Search for the devices we want to send to</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.item.TransportItem.simplify_parts">
<code class="descname">simplify_parts</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.item.TransportItem.simplify_parts" title="Permalink to this definition">¶</a></dt>
<dd><p>Simiplify our parts such that their payloads are bitarrays.</p>
<p>Unless a packet is dynamically created (has a callable field)
in which case, we just return packet as is</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.item.TransportItem.write_messages">
<em class="property">async for ... in </em><code class="descname">write_messages</code><span class="sig-paren">(</span><em>packets</em>, <em>check_packet</em>, <em>make_writer</em>, <em>make_waiter</em>, <em>timeout</em>, <em>error_catcher</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.item.TransportItem.write_messages" title="Permalink to this definition">¶</a></dt>
<dd><p>Make a bunch of writers and then use them to create waiters</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-photons_transport.target.waiter">
<span id="the-waiter"></span><h2>The waiter<a class="headerlink" href="#module-photons_transport.target.waiter" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="photons_transport.target.waiter.FutPair">
<em class="property">class </em><code class="descclassname">photons_transport.target.waiter.</code><code class="descname">FutPair</code><span class="sig-paren">(</span><em>parentfut</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.FutPair" title="Permalink to this definition">¶</a></dt>
<dd><p>A future who takes in a future that resolves to two futures.</p>
<p>This future is cancelled or raises an error if any of these futures are
cancelled or raise an error.</p>
<p>This future eventually resolves to the result of the second result future if
the first result future is also resolved.</p>
<p>So say we have:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="n">final_fut1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<span class="n">final_fut2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>

<span class="n">fut</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">((</span><span class="n">final_fut1</span><span class="p">,</span> <span class="n">final_fut2</span><span class="p">))</span>
</pre></div>
</div>
<p>Then:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">final</span> <span class="o">=</span> <span class="n">FutPair</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span>

<span class="n">final_fut1</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">final_fut1</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">final_result</span><span class="p">)</span>

<span class="k">assert</span> <span class="p">(</span><span class="n">await</span> <span class="n">final</span><span class="p">)</span> <span class="ow">is</span> <span class="n">final_result</span>
</pre></div>
</div>
<dl class="method">
<dt id="photons_transport.target.waiter.FutPair.add_done_callback">
<code class="descname">add_done_callback</code><span class="sig-paren">(</span><em>func</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.FutPair.add_done_callback" title="Permalink to this definition">¶</a></dt>
<dd><p>Ensure func gets put onto the loop when the FutPair is done.</p>
<p>This means if our parentfut is not done, it gets registered in
done_callback and used when parentfut and subsequent res_fut is done.</p>
<p>Otherwise, if parentfut is already finished and the ack_fut is already finished,
we may have missed the boat with the _parent_done_cb we add to the ack,
so we put the func straight onto the res_fut itself</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.waiter.FutPair.set_final">
<code class="descname">set_final</code><span class="sig-paren">(</span><em>res</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.FutPair.set_final" title="Permalink to this definition">¶</a></dt>
<dd><p>This callback is called on the completion of FutPair, as registered
by the __init__</p>
<p>Essentially it’s just transferring the result from the res_fut onto the
self.final future.</p>
<p>We also protect against setting a result on the final when it already has
a result or cancellation.</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.waiter.FutPair.set_final_cb">
<code class="descname">set_final_cb</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.FutPair.set_final_cb" title="Permalink to this definition">¶</a></dt>
<dd><p>Make sure we setup our callbacks, otherwise final will never be completed</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.waiter.FutPair.set_result">
<code class="descname">set_result</code><span class="sig-paren">(</span><em>data</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.FutPair.set_result" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets a result on final.</p>
<p>Also cancels parentfut or ack_fut/res_fut if parentfut is already done</p>
<p>This is because we are preferring the result from this call over whatever
those futures provide, so we should stop them</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="photons_transport.target.waiter.Waiter">
<em class="property">class </em><code class="descclassname">photons_transport.target.waiter.</code><code class="descname">Waiter</code><span class="sig-paren">(</span><em>stop_fut</em>, <em>writer</em>, <em>first_resend=0.1</em>, <em>first_wait=0.1</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.Waiter" title="Permalink to this definition">¶</a></dt>
<dd><p>Keep writing till we get a response!</p>
<p>It’s up to the caller to cancel this if we take too long</p>
<p>This object is a future, the result of which is the final response from our
writer.</p>
<p>We expect to get back <code class="docutils literal"><span class="pre">(ack_fut,</span> <span class="pre">res_fut)</span></code> from <code class="docutils literal"><span class="pre">writer</span></code> which we create
a <code class="docutils literal"><span class="pre">FutPair</span></code> from. We keep collecting these until one of the <code class="docutils literal"><span class="pre">FutPair</span></code>
resolves and we have a result.</p>
<p>When this happens we set the result/error/cancellation on all the other
futures that were created in the process.</p>
<p>We keep writing writer with an exponential backoff.</p>
<dl class="method">
<dt id="photons_transport.target.waiter.Waiter.determine_next_time">
<code class="descname">determine_next_time</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.Waiter.determine_next_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Determine when to write next.</p>
<p>We are super optimistic at first, and lose interest quickly</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.waiter.Waiter.writings">
<em class="property">await </em><code class="descname">writings</code><span class="sig-paren">(</span><em>*args</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.waiter.Waiter.writings" title="Permalink to this definition">¶</a></dt>
<dd><p>Keep writing till we fulfill that future!!!</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-photons_transport.target.writer">
<span id="the-writer"></span><h2>The writer<a class="headerlink" href="#module-photons_transport.target.writer" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="photons_transport.target.writer.Executor">
<em class="property">class </em><code class="descclassname">photons_transport.target.writer.</code><code class="descname">Executor</code><span class="sig-paren">(</span><em>writer</em>, <em>packet</em>, <em>conn</em>, <em>serial</em>, <em>addr</em>, <em>target</em>, <em>expect_zero</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Executor" title="Permalink to this definition">¶</a></dt>
<dd><p>Container of information necessary for writing to a device.</p>
<p>Ultimately it uses the Writer that’s passed in to do the actual writing</p>
</dd></dl>

<dl class="class">
<dt id="photons_transport.target.writer.Writer">
<em class="property">class </em><code class="descclassname">photons_transport.target.writer.</code><code class="descname">Writer</code><span class="sig-paren">(</span><em>bridge</em>, <em>packet</em>, <em>conn=None</em>, <em>addr=None</em>, <em>multiple_replies=False</em>, <em>broadcast=False</em>, <em>desired_services=None</em>, <em>found=None</em>, <em>connect_timeout=10</em>, <em>expect_zero=False</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer" title="Permalink to this definition">¶</a></dt>
<dd><p>Does what it says on the tin! This writes to a device using the bridge that
is passed in.</p>
<p>Usage is via the bridge.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">writer</span> <span class="o">=</span> <span class="n">await</span> <span class="n">bridge</span><span class="o">.</span><span class="n">make_writer</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">ack_fut</span><span class="p">,</span> <span class="n">res_fut</span> <span class="o">=</span> <span class="n">await</span> <span class="n">writer</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">await</span> <span class="n">res_fut</span><span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="photons_transport.target.writer.Writer.determine_addr">
<em class="property">await </em><code class="descname">determine_addr</code><span class="sig-paren">(</span><em>target</em>, <em>serial</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer.determine_addr" title="Permalink to this definition">¶</a></dt>
<dd><p>Use <code class="docutils literal"><span class="pre">self.bridge.find</span></code> to find the address of our target</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.writer.Writer.display_written">
<code class="descname">display_written</code><span class="sig-paren">(</span><em>bts</em>, <em>serial</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer.display_written" title="Permalink to this definition">¶</a></dt>
<dd><p>Log out what we just wrote to the connection</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.writer.Writer.make">
<em class="property">await </em><code class="descname">make</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer.make" title="Permalink to this definition">¶</a></dt>
<dd><p>Return an asynchronous callable that when called and awaited returns a pair of futures
representing the acknowledgement and result from sending this packet
to the device</p>
<p>This function also ensures that the bridge has a receiver setup.</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.writer.Writer.normalise_target">
<code class="descname">normalise_target</code><span class="sig-paren">(</span><em>packet</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer.normalise_target" title="Permalink to this definition">¶</a></dt>
<dd><p>Make sure our target is 6 bytes and our serial is a hex string</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.writer.Writer.prepare">
<em class="property">await </em><code class="descname">prepare</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer.prepare" title="Permalink to this definition">¶</a></dt>
<dd><p>Used by <code class="docutils literal"><span class="pre">make</span></code> to get us the <code class="docutils literal"><span class="pre">Executor</span></code> instance that’ll be used to
do the writing</p>
</dd></dl>

<dl class="method">
<dt id="photons_transport.target.writer.Writer.write">
<em class="property">await </em><code class="descname">write</code><span class="sig-paren">(</span><em>serial</em>, <em>packet</em>, <em>clone</em>, <em>conn</em>, <em>addr</em>, <em>made_futures</em>, <em>expect_zero=False</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_transport.target.writer.Writer.write" title="Permalink to this definition">¶</a></dt>
<dd><p>Return two futures representing the acknowledgement and result of writing
this message to the device.</p>
<p>If the packet has False for <code class="docutils literal"><span class="pre">ack_required</span></code> then the acknoledgement
future is already resolved to <code class="docutils literal"><span class="pre">True</span></code>.</p>
<p>If <code class="docutils literal"><span class="pre">res_required</span></code> is False, then the result future is already resolved
to an empty list.</p>
<p>We allow these futures to be resolved by telling the bridge to expect
results for this <code class="docutils literal"><span class="pre">(source,</span> <span class="pre">sequence,</span> <span class="pre">target)</span></code> combination.</p>
<p>Finally, we use <code class="docutils literal"><span class="pre">bridge.write_to_conn</span></code> if it is defined, otherwise
we use <code class="docutils literal"><span class="pre">bridge.write_to_sock</span></code>. The difference between them is
<code class="docutils literal"><span class="pre">write_to_sock</span></code> does not require awaiting, whereas <code class="docutils literal"><span class="pre">write_to_conn</span></code>
does.</p>
</dd></dl>

</dd></dl>

</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="photons_transform.html" class="btn btn-neutral" title="photons_transform" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Stephen Moore.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>