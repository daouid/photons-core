

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Planner &mdash; Photons 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Photons 0.1 documentation" href="index.html"/>
        <link rel="next" title="Config file" href="config_file.html"/>
        <link rel="prev" title="The Script Mechanism" href="script_mechanism.html"/>
   
	<link rel="stylesheet" href="_static/css/styles.css" type="text/css"/>


  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Photons
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lifx_script.html">LIFX script</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripts.html">Making a Photons Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Using Photons as a library</a></li>
<li class="toctree-l1"><a class="reference internal" href="venvstarter.html">Using Venvstarter</a></li>
<li class="toctree-l1"><a class="reference internal" href="script_mechanism.html">The Script Mechanism</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Planner</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#plans">Plans</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="config_file.html">Config file</a></li>
<li class="toctree-l1"><a class="reference internal" href="discovery.html">Device Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="finding_serials.html">Finding Serials</a></li>
<li class="toctree-l1"><a class="reference internal" href="tile_animations.html">Tile Animations</a></li>
<li class="toctree-l1"><a class="reference internal" href="packets.html">Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="known_issues.html">Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">ChangeLog</a></li>
<li class="toctree-l1"><a class="reference internal" href="photons_app/index.html">photons_app</a></li>
<li class="toctree-l1"><a class="reference internal" href="binary_protocol.html">LIFX Binary protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="available_modules.html">Available Photons Modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Photons</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Planner</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/planner.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="planner">
<span id="id1"></span><h1>Planner<a class="headerlink" href="#planner" title="Permalink to this headline">¶</a></h1>
<span class="target" id="module-photons_control.planner"></span><p>The planner is a mechanism for gathering information from many devices and
receive that information as we get it. This handles getting multiple pieces of
information, information that depends on other information, and also handles
getting information to you as it’s received without having to wait for slower
devices.</p>
<p>Usage is via the Gatherer class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">photons_control.planner</span> <span class="kn">import</span> <span class="n">Gatherer</span><span class="p">,</span> <span class="n">make_plans</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">Gatherer</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">plans</span> <span class="o">=</span> <span class="n">make_plans</span><span class="p">(</span><span class="s2">&quot;power&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">)</span>

<span class="n">async</span> <span class="k">for</span> <span class="n">serial</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">reference</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<dl class="class">
<dt id="photons_control.planner.gatherer.Gatherer">
<em class="property">class </em><code class="descclassname">photons_control.planner.gatherer.</code><code class="descname">Gatherer</code><span class="sig-paren">(</span><em>target</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_control.planner.gatherer.Gatherer" title="Permalink to this definition">¶</a></dt>
<dd><p>This class is used by users to gather information from your devices.</p>
<p>Usage looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">photons_control.planner</span> <span class="kn">import</span> <span class="n">Gatherer</span><span class="p">,</span> <span class="n">make_plans</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">Gatherer</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">plans</span> <span class="o">=</span> <span class="n">make_plans</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;power&quot;</span><span class="p">)</span>

<span class="n">async</span> <span class="k">for</span> <span class="n">serial</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;d073d5000001&quot;</span><span class="p">,</span> <span class="s2">&quot;d073d5000002&quot;</span><span class="p">]):</span>
    <span class="c1"># label will be &quot;label&quot; or &quot;power&quot;</span>
    <span class="c1"># serial will be the serial of the device</span>
    <span class="c1"># info will be the information associated with that plan</span>
    <span class="c1"># Information is sent to you as it is received.</span>
</pre></div>
</div>
<p>If you already have an afr, you can provide it when gathering information:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">for</span> <span class="n">serial</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;d073d5000001&quot;</span><span class="p">,</span> <span class="s2">&quot;d073d5000002&quot;</span><span class="p">],</span> <span class="n">afr</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If you don’t supply an afr, one will be created and cleaned up for you.</p>
<p>If you supply limit as a number to any gather method, then it will be
converted into a semaphore for you that is shared by all run_with calls.</p>
<p>There are three methods on this for gathering information:</p>
<ul class="simple">
<li>gather - yield (serial, label, info) tuples for each plan as they are
completed per device</li>
<li>gather_all - return {serial: (completed, info)} dictionary where completed
is a boolean that is True if we received all information for this device
and info is a dictionary of {label: &lt;information from plan&gt;}</li>
<li>gather_per_serial - yield (serial, completed, info) for each device where
completed and info is the same as for gather_all, but per device.</li>
</ul>
<p>All these methods take in the same arguments as run_with, but with an extra
positional argument before reference which is a dictionary of labels to plan
instances. You may use the make_plans function to create this dictionary of
plans.</p>
<p>For example, the following is the same:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">photons_control.planner</span> <span class="kn">import</span> <span class="n">make_plans</span>

<span class="c1"># Use the registered power plan</span>
<span class="n">plans</span> <span class="o">=</span> <span class="n">make_plans</span><span class="p">(</span><span class="s2">&quot;power&quot;</span><span class="p">)</span>

<span class="c1"># Use the power plan manually</span>
<span class="kn">from</span> <span class="nn">photons_control.planner.plans</span> <span class="kn">import</span> <span class="n">PowerPlan</span>
<span class="n">plans</span> <span class="o">=</span> <span class="n">make_plans</span><span class="p">(</span><span class="n">power</span><span class="o">=</span><span class="n">PowerPlan</span><span class="p">())</span>
</pre></div>
</div>
<p>The first form is easier because you don’t have to import the plan, but does
require the plan has been registered. The second form is more flexible as you
may define a custom refresh when you instantiate the plan and you may also
give the plan a different label.</p>
<p>Note that results from gathering will be cached and you may remove this cache
by calling gatherer.clear_cache()</p>
</dd></dl>

<dl class="function">
<dt id="photons_control.planner.plans.make_plans">
<code class="descclassname">photons_control.planner.plans.</code><code class="descname">make_plans</code><span class="sig-paren">(</span><em>*by_key</em>, <em>**plans</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_control.planner.plans.make_plans" title="Permalink to this definition">¶</a></dt>
<dd><p>Given by_key which is a list of strings and plans which is a dictionary of key to
plan, return a dictionary of key to plans.</p>
<p>We will complain if:</p>
<ul class="simple">
<li>A key in by_key is not a registered plan</li>
<li>A key in by_key is also in plans</li>
</ul>
</dd></dl>

<div class="section" id="plans">
<h2>Plans<a class="headerlink" href="#plans" title="Permalink to this headline">¶</a></h2>
<p>The gatherer is just a mechanism that executes plans. There are default plans
that are registered with default names, and you may use those labels as positional
arguments to the make_plans function to get a plans dictionary with those plans.</p>
<p>Or you may create your own plans by subclassing the Plan class.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Using a_plan decorator is optional, and is just for registering a name</span>
<span class="c1"># for this plan</span>
<span class="nd">@a_plan</span><span class="p">(</span><span class="s2">&quot;uptime&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UptimePlan</span><span class="p">(</span><span class="n">Plan</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">DeviceMessages</span><span class="o">.</span><span class="n">GetInfo</span><span class="p">()]</span>

    <span class="k">class</span> <span class="nc">Instance</span><span class="p">(</span><span class="n">Plan</span><span class="o">.</span><span class="n">Instance</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
            <span class="c1"># This method gets all replies from the device, not just</span>
            <span class="c1"># replies to the messages sent by this plan</span>
            <span class="k">if</span> <span class="n">pkt</span> <span class="o">|</span> <span class="n">DeviceMessages</span><span class="o">.</span><span class="n">StateInfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">uptime</span>
                <span class="c1"># We have information, tell the planner to use info() to get</span>
                <span class="c1"># the final result from this plan</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="n">async</span> <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span>

<span class="c1"># We&#39;ve used a_plan, so we can either use this plan by name like:</span>
<span class="n">plans</span> <span class="o">=</span> <span class="n">make_plans</span><span class="p">(</span><span class="s2">&quot;uptime&quot;</span><span class="p">)</span>
<span class="n">async</span> <span class="k">for</span> <span class="n">serial</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
    <span class="o">....</span>

<span class="c1"># Or we can use the plan directly</span>
<span class="n">plans</span> <span class="o">=</span> <span class="n">make_plans</span><span class="p">(</span><span class="n">uptime</span><span class="o">=</span><span class="n">UptimePlan</span><span class="p">())</span>
<span class="n">async</span> <span class="k">for</span> <span class="n">serial</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<dl class="class">
<dt id="photons_control.planner.plans.Plan">
<em class="property">class </em><code class="descclassname">photons_control.planner.plans.</code><code class="descname">Plan</code><span class="sig-paren">(</span><em>*args</em>, <em>refresh=&lt;class 'delfick_project.norms.spec_base.NotSpecified'&gt;</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#photons_control.planner.plans.Plan" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for plans. A plan is an object that specifies what messages to
send to a device, How to process any message that the device sends back and
how to create a final artifact that represents the value from this plan.</p>
<p>Usage looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPlan</span><span class="p">(</span><span class="n">Plan</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">DeviceMessages</span><span class="o">.</span><span class="n">GetPower</span><span class="p">()]</span>

    <span class="k">class</span> <span class="nc">Instance</span><span class="p">(</span><span class="n">Plan</span><span class="o">.</span><span class="n">Instance</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pkt</span> <span class="o">|</span> <span class="n">DeviceMessages</span><span class="o">.</span><span class="n">StatePower</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">level</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="n">async</span> <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">}</span>
</pre></div>
</div>
<p>There are some properties on the Plan itself:</p>
<ul class="simple">
<li>messages - Default None - a list of messages to send to the device.
If you want to choose based on the device itself, then define messages on
the Instance where you have access to the deps and serial.</li>
<li>dependant_info - Default None - An optional dictionary of key to Plan class
that is used to get dependency information for this plan. For example if
you say <code class="docutils literal"><span class="pre">dependant_info</span> <span class="pre">=</span> <span class="pre">{&quot;c&quot;:</span> <span class="pre">CapabilityPlan()}</span></code> then the plan will
only be executed once we have information from the CapabilityPlan and the
Instance will have <code class="docutils literal"><span class="pre">self.deps</span> <span class="pre">=</span> <span class="pre">{&quot;c&quot;:</span> <span class="pre">&lt;info</span> <span class="pre">from</span> <span class="pre">capability</span> <span class="pre">plan&gt;}</span></code> for
use.</li>
<li>default_refresh - Default 10 - Either True if you never want to re-use
results from this plan. False if you never want to remove the results from
this plan, or an integer representing the number of seconds before the
cache expires. If the cache expires then the messages defined by this plan
are resent to the device. Note that this is overridden if you specify
refresh when you instantiate the plan.</li>
<li>setup - Method - Called by __init__ with all positional and keyword
arguments used to instantiate the plan except refresh. Note that before
setup is called, self.refresh will be set on the class as either the
refresh keyword argument if provided or the default_refresh on the plan</li>
<li>Instance - Class - The logic for processing packets from the device and
getting the final information for the plan.</li>
</ul>
<p>The Instance class will be instantiated per device that the planner is
looking at. It is also possible to define messages on the Instance. If you
want to have logic for determining what messages to send, then just make
messages a method with an <code class="docutils literal"><span class="pre">&#64;property</span></code> decorator.</p>
<p>If you define messages on the instance you have access to:</p>
<ul class="simple">
<li>self.parent – the plan instance used to create this device Instance</li>
<li>self.deps – Dependency information as defined by dependant_info on the parent</li>
<li>self.serial – the serial for this device</li>
<li>Anything else on the instance defined in the setup hook</li>
</ul>
<p>The Instance has the following hooks and properties:</p>
<ul class="simple">
<li>messages - Default None - A list of messages to send to the device. If this
is not defined, then messages on the parent is used. If this is Skip then
the plan is not executed for this device.</li>
<li>finished_after_no_more_messages - default False - This plan should be
considered done if it already isn’t considered done and we don’t have any
more messages from devices.</li>
<li>setup - Method - Any setup specific to this device. You have self.deps,
self.parent and self.serial at this point.</li>
<li>refresh - property - Defaults to self.parent.refresh - The refresh for this
instance of data.</li>
<li>key - Method, defaults to self.parent.__class__ - A key used to represent
this plan, so that future executions of this plan can reuse the final
information for this serial without sending more messages.</li>
<li>process - Method - does nothing by default, it is used to process all messages
that the device sends back, not just replies to the messages asked for by
the plan. You must return True from this method when you have received
enough information. Once we return True then info will be called to get
the final result for this plan. Note that if the messages on this plan is
the NoMessages class then this method will never be called. By  default
this method raises NotImplementedError.</li>
<li>info - Async method - Must be overridden - This is called when the plan is
considered done for this device and returns whatever information you want.</li>
</ul>
</dd></dl>

<dl class="class">
<dt id="photons_control.planner.plans.Skip">
<em class="property">class </em><code class="descclassname">photons_control.planner.plans.</code><code class="descname">Skip</code><a class="headerlink" href="#photons_control.planner.plans.Skip" title="Permalink to this definition">¶</a></dt>
<dd><p>Plans that return this instead of messages are saying to the planner
to not invoke this plan for this device</p>
</dd></dl>

<dl class="class">
<dt id="photons_control.planner.plans.NoMessages">
<em class="property">class </em><code class="descclassname">photons_control.planner.plans.</code><code class="descname">NoMessages</code><a class="headerlink" href="#photons_control.planner.plans.NoMessages" title="Permalink to this definition">¶</a></dt>
<dd><p>Plans that return this instead of messages are saying to the planner
to just call plan.info() and use the result from that rather than processing
any messages that are sent from the device</p>
</dd></dl>

</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="config_file.html" class="btn btn-neutral float-right" title="Config file" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="script_mechanism.html" class="btn btn-neutral" title="The Script Mechanism" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Stephen Moore.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>